<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroBio Explorer Pro - Advanced 3D Interactive Microbiology</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Professional Scientific Color Palette */
            --bacteria-primary: #1e3a8a;
            --bacteria-secondary: #3b82f6;
            --bacteria-accent: #60a5fa;
            
            --virus-primary: #dc2626;
            --virus-secondary: #ef4444;
            --virus-accent: #f87171;
            
            --fungi-primary: #92400e;
            --fungi-secondary: #d97706;
            --fungi-accent: #fbbf24;
            
            --protozoa-primary: #7c2d12;
            --protozoa-secondary: #c2410c;
            --protozoa-accent: #fb923c;
            
            --algae-primary: #065f46;
            --algae-secondary: #10b981;
            --algae-accent: #34d399;
            
            --bg-dark: #0f172a;
            --bg-surface: #1e293b;
            --bg-surface-elevated: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #475569;
            
            --glow-bacteria: #3b82f6;
            --glow-virus: #ef4444;
            --glow-fungi: #d97706;
            --glow-protozoa: #c2410c;
            --glow-algae: #10b981;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            background-image: 
                radial-gradient(ellipse at top, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(239, 68, 68, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom left, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        header {
            padding: 2rem 0;
            text-align: center;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.2), rgba(220, 38, 38, 0.2));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--bacteria-secondary), var(--virus-secondary), var(--algae-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .tagline {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 1rem;
        }

        .hero-stat {
            text-align: center;
        }

        .hero-stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--bacteria-accent);
        }

        .hero-stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .search-section {
            margin: 3rem 0;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .search-input {
            flex: 1;
            max-width: 400px;
            padding: 1rem 1.5rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 50px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--bacteria-accent);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-surface-elevated);
            border: 1px solid var(--border);
            border-radius: 25px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .filter-btn.active {
            background: var(--bacteria-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .microorganism-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .micro-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .micro-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .micro-card.bacteria:hover { border-color: var(--bacteria-accent); }
        .micro-card.virus:hover { border-color: var(--virus-accent); }
        .micro-card.fungi:hover { border-color: var(--fungi-accent); }
        .micro-card.protozoa:hover { border-color: var(--protozoa-accent); }
        .micro-card.algae:hover { border-color: var(--algae-accent); }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card-icon {
            font-size: 3rem;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .card-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .card-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .card-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--bacteria-primary), var(--bacteria-secondary));
            color: white;
        }

        .btn-secondary {
            background: var(--bg-surface-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-surface);
            margin: 2% auto;
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 2rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .canvas-container {
            position: relative;
            background: var(--bg-dark);
            border-radius: 15px;
            overflow: hidden;
        }

        #mainCanvas {
            width: 100%;
            height: 500px;
            display: block;
        }

        .canvas-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-direction: column;
        }

        .control-btn {
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .inner-view-panel {
            background: var(--bg-surface-elevated);
            border-radius: 15px;
            padding: 1.5rem;
            height: 500px;
            overflow-y: auto;
        }

        .structure-list {
            list-style: none;
        }

        .structure-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-surface);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .structure-item:hover {
            background: var(--bg-surface-elevated);
            transform: translateX(5px);
        }

        .structure-item.active {
            background: var(--bacteria-primary);
            color: white;
        }

        .info-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 25px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: var(--bacteria-primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .structure-details {
            margin-top: 1rem;
        }

        .structure-details h4 {
            color: var(--bacteria-accent);
            margin-bottom: 0.5rem;
        }

        .structure-details p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .label-overlay {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.75rem;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .modal-body {
                grid-template-columns: 1fr;
            }
            
            .microorganism-grid {
                grid-template-columns: 1fr;
            }
            
            .hero-stats {
                flex-direction: column;
                gap: 1rem;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .zoom-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 25px;
        }

        .zoom-btn {
            padding: 0.5rem;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .inner-explorer {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .inner-explorer:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 class="logo">🧬 MicroBio Explorer Pro</h1>
            <p class="tagline">Advanced 3D Interactive Microbiology Learning Platform</p>
            <div class="hero-stats">
                <div class="hero-stat">
                    <div class="hero-stat-number">5</div>
                    <div class="hero-stat-label">Microorganism Types</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">3D</div>
                    <div class="hero-stat-label">Interactive Models</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-number">∞</div>
                    <div class="hero-stat-label">Exploration Possibilities</div>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="search-section">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search microorganisms...">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All Types</button>
                <button class="filter-btn" data-filter="bacteria">Bacteria</button>
                <button class="filter-btn" data-filter="virus">Viruses</button>
                <button class="filter-btn" data-filter="fungi">Fungi</button>
                <button class="filter-btn" data-filter="protozoa">Protozoa</button>
                <button class="filter-btn" data-filter="algae">Algae</button>
            </div>
        </section>

        <section class="microorganism-grid" id="microorganismGrid">
            <!-- Cards will be populated dynamically -->
        </section>
    </main>

    <!-- Advanced Modal with 3D Models -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Microorganism Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="canvas-container">
                    <canvas id="mainCanvas"></canvas>
                    <div class="canvas-controls">
                        <button class="control-btn" onclick="toggleRotation()">⏯ Rotate</button>
                        <button class="control-btn" onclick="toggleLabels()">🏷 Labels</button>
                        <button class="control-btn" onclick="toggle2D3D()">2D/3D</button>
                        <button class="control-btn" onclick="resetView()">⟲ Reset</button>
                    </div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomIn()">+</button>
                        <button class="zoom-btn" onclick="zoomOut()">-</button>
                    </div>
                    <button class="inner-explorer" onclick="enterInnerView()">🔬 Enter Inner View</button>
                    <div class="label-overlay" id="labelOverlay" style="display: none;">
                        Hover over structures to see labels
                    </div>
                </div>
                
                <div class="inner-view-panel">
                    <div class="info-tabs">
                        <button class="tab-btn active" data-tab="overview">Overview</button>
                        <button class="tab-btn" data-tab="structures">Structures</button>
                        <button class="tab-btn" data-tab="functions">Functions</button>
                    </div>
                    
                    <div id="overview-tab" class="tab-content active">
                        <h3>Overview</h3>
                        <p id="overview-content">Select a microorganism to explore...</p>
                    </div>
                    
                    <div id="structures-tab" class="tab-content">
                        <h3>Cell Structures</h3>
                        <ul class="structure-list" id="structureList"></ul>
                        <div class="structure-details" id="structureDetails"></div>
                    </div>
                    
                    <div id="functions-tab" class="tab-content">
                        <h3>Biological Functions</h3>
                        <div id="functions-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced microorganism data with detailed structures
        const microorganisms = {
            bacteria: {
                name: "Bacteria",
                icon: "🦠",
                description: "Prokaryotic cells with complex membrane systems",
                color: "#3b82f6",
                structures: [
                    { name: "Cell Wall", description: "Rigid peptidoglycan layer providing shape and protection", position: [1, 0, 0] },
                    { name: "Plasma Membrane", description: "Phospholipid bilayer regulating transport", position: [0.8, 0, 0] },
                    { name: "Nucleoid", description: "DNA-containing region without nuclear membrane", position: [0, 0, 0] },
                    { name: "Ribosomes", description: "Protein synthesis machinery", position: [0.2, 0.3, 0.2] },
                    { name: "Flagellum", description: "Rotary motor for locomotion", position: [-1, 0, 0] },
                    { name: "Pili", description: "Hair-like appendages for attachment", position: [0.9, 0.5, 0] }
                ],
                overview: "Bacteria are single-celled prokaryotic organisms that lack membrane-bound organelles. They exhibit remarkable diversity in morphology, metabolism, and ecological roles.",
                functions: [
                    "Nitrogen fixation in soil ecosystems",
                    "Fermentation and food production",
                    "Decomposition of organic matter",
                    "Symbiotic relationships in gut microbiome",
                    "Pathogenic mechanisms in disease"
                ]
            },
            virus: {
                name: "Virus",
                icon: "🦠",
                description: "Non-cellular infectious particles with genetic material",
                color: "#ef4444",
                structures: [
                    { name: "Capsid", description: "Protein shell protecting genetic material", position: [0, 0, 0] },
                    { name: "Genome", description: "DNA or RNA carrying genetic information", position: [0, 0, 0] },
                    { name: "Envelope", description: "Lipid membrane derived from host cell", position: [0, 0, 0] },
                    { name: "Spike Proteins", description: "Glycoproteins for host cell recognition", position: [0.7, 0.7, 0.7] },
                    { name: "Matrix Proteins", description: "Structural proteins between envelope and capsid", position: [0.5, 0, 0] }
                ],
                overview: "Viruses are infectious agents that can only replicate inside living host cells. They consist of genetic material enclosed in a protein coat, sometimes with an outer lipid envelope.",
                functions: [
                    "Host cell recognition and entry",
                    "Genetic material replication",
                    "Assembly of new viral particles",
                    "Host immune system evasion",
                    "Horizontal gene transfer"
                ]
            },
            fungi: {
                name: "Fungi",
                icon: "🍄",
                description: "Eukaryotic organisms with chitin cell walls",
                color: "#d97706",
                structures: [
                    { name: "Cell Wall", description: "Chitin and glucan-based rigid structure", position: [1, 0, 0] },
                    { name: "Septum", description: "Cross-walls dividing hyphal cells", position: [0.5, 0, 0] },
                    { name: "Nucleus", description: "Membrane-bound DNA-containing organelle", position: [0.3, 0.3, 0.3] },
                    { name: "Mitochondria", description: "Energy-producing organelles", position: [0.4, -0.4, 0.2] },
                    { name: "Vacuole", description: "Storage organelle for nutrients and waste", position: [0, 0.5, 0] }
                ],
                overview: "Fungi are eukaryotic organisms that include yeasts, molds, and mushrooms. They play crucial roles in decomposition, nutrient cycling, and symbiotic relationships.",
                functions: [
                    "Decomposition of complex organic matter",
                    "Mycorrhizal associations with plants",
                    "Antibiotic production",
                    "Fermentation processes",
                    "Pathogenic infections"
                ]
            },
            protozoa: {
                name: "Protozoa",
                icon: "🦠",
                description: "Single-celled eukaryotic organisms with complex organelles",
                color: "#c2410c",
                structures: [
                    { name: "Cell Membrane", description: "Flexible phospholipid bilayer", position: [0.9, 0, 0] },
                    { name: "Nucleus", description: "Large central DNA-containing organelle", position: [0, 0, 0] },
                    { name: "Contractile Vacuole", description: "Water regulation organelle", position: [-0.5, 0.5, 0] },
                    { name: "Food Vacuole", description: "Digestive compartment for nutrients", position: [0.3, -0.3, 0] },
                    { name: "Cilia", description: "Hair-like structures for locomotion", position: [0.8, 0.5, 0] }
                ],
                overview: "Protozoa are single-celled eukaryotic organisms that exhibit diverse forms of locomotion and feeding strategies. They play important roles in aquatic food webs and nutrient cycling.",
                functions: [
                    "Phagocytosis and nutrient cycling",
                    "Population control of bacteria and algae",
                    "Symbiotic relationships in digestive systems",
                    "Parasitic life cycles in hosts",
                    "Indicator species for water quality"
                ]
            },
            algae: {
                name: "Algae",
                icon: "🌿",
                description: "Photosynthetic eukaryotic organisms with chloroplasts",
                color: "#10b981",
                structures: [
                    { name: "Cell Wall", description: "Cellulose-based rigid structure", position: [1, 0, 0] },
                    { name: "Chloroplast", description: "Photosynthetic organelle with chlorophyll", position: [0.5, 0.3, 0] },
                    { name: "Pyrenoid", description: "Starch formation center in chloroplast", position: [0.5, 0.3, 0] },
                    { name: "Nucleus", description: "Central DNA-containing organelle", position: [0, 0, 0] },
                    { name: "Flagella", description: "Locomotor appendages", position: [-0.8, 0, 0] }
                ],
                overview: "Algae are photosynthetic eukaryotic organisms ranging from single-celled microalgae to large seaweeds. They are primary producers in aquatic ecosystems and produce much of Earth's oxygen.",
                functions: [
                    "Photosynthesis and oxygen production",
                    "Primary production in aquatic food webs",
                    "Carbon sequestration and climate regulation",
                    "Biofuel production",
                    "Food and pharmaceutical applications"
                ]
            }
        };

        let currentMicroorganism = null;
        let isRotating = true;
        let showLabels = false;
        let is3D = true;
        let zoomLevel = 1;
        let rotationAngle = 0;
        let innerViewActive = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderMicroorganisms();
            setupEventListeners();
        });

        function renderMicroorganisms(filter = 'all', searchTerm = '') {
            const grid = document.getElementById('microorganismGrid');
            grid.innerHTML = '';

            Object.entries(microorganisms).forEach(([key, micro]) => {
                if (filter !== 'all' && key !== filter) return;
                if (searchTerm && !micro.name.toLowerCase().includes(searchTerm.toLowerCase())) return;

                const card = createMicroCard(key, micro);
                grid.appendChild(card);
            });
        }

        function createMicroCard(key, micro) {
            const card = document.createElement('div');
            card.className = `micro-card ${key}`;
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">${micro.icon}</span>
                    <h3 class="card-title" style="color: ${micro.color}">${micro.name}</h3>
                </div>
                <p class="card-description">${micro.description}</p>
                <div class="card-stats">
                    <div class="stat-item">
                        <span class="stat-number">${micro.structures.length}</span>
                        <span class="stat-label">Structures</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${micro.functions.length}</span>
                        <span class="stat-label">Functions</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="openModal('${key}')">Explore 3D Model</button>
                    <button class="btn btn-secondary" onclick="quickView('${key}')">Quick View</button>
                </div>
            `;
            return card;
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const filterButtons = document.querySelectorAll('.filter-btn');

            searchInput.addEventListener('input', (e) => {
                const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                renderMicroorganisms(activeFilter, e.target.value);
            });

            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderMicroorganisms(btn.dataset.filter, searchInput.value);
                });
            });
        }

        function openModal(microKey) {
            currentMicroorganism = microorganisms[microKey];
            const modal = document.getElementById('detailModal');
            document.getElementById('modalTitle').textContent = currentMicroorganism.name;
            document.getElementById('overview-content').textContent = currentMicroorganism.overview;
            
            populateStructureList();
            populateFunctionsList();
            
            modal.style.display = 'block';
            initCanvas();
            animate();
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            isRotating = false;
        }

        function populateStructureList() {
            const list = document.getElementById('structureList');
            const details = document.getElementById('structureDetails');
            
            list.innerHTML = '';
            currentMicroorganism.structures.forEach((structure, index) => {
                const item = document.createElement('li');
                item.className = 'structure-item';
                item.textContent = structure.name;
                item.onclick = () => highlightStructure(index);
                list.appendChild(item);
            });
        }

        function populateFunctionsList() {
            const container = document.getElementById('functions-content');
            container.innerHTML = '<ul>' + 
                currentMicroorganism.functions.map(f => `<li>${f}</li>`).join('') + 
                '</ul>';
        }

        function initCanvas() {
            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            
            canvas.width = container.offsetWidth;
            canvas.height = 500;
        }

        function animate() {
            if (!currentMicroorganism) return;

            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (isRotating) {
                rotationAngle += 0.01;
            }
            
            if (is3D) {
                draw3DModel(ctx, canvas.width / 2, canvas.height / 2, Math.min(canvas.width, canvas.height) * 0.3 * zoomLevel);
            } else {
                draw2DModel(ctx, canvas.width / 2, canvas.height / 2, Math.min(canvas.width, canvas.height) * 0.3 * zoomLevel);
            }
            
            if (showLabels) {
                drawLabels(ctx);
            }
            
            requestAnimationFrame(animate);
        }

        function draw3DModel(ctx, x, y, size) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(zoomLevel, zoomLevel);
            ctx.rotate(rotationAngle);
            
            const color = currentMicroorganism.color;
            
            // Draw microorganism type-specific 3D model
            switch(currentMicroorganism.name.toLowerCase()) {
                case 'bacteria':
                    draw3DBacteria(ctx, size, color);
                    break;
                case 'virus':
                    draw3DVirus(ctx, size, color);
                    break;
                case 'fungi':
                    draw3DFungi(ctx, size, color);
                    break;
                case 'protozoa':
                    draw3DProtozoa(ctx, size, color);
                    break;
                case 'algae':
                    draw3DAlgae(ctx, size, color);
                    break;
            }
            
            ctx.restore();
        }

        function draw2DModel(ctx, x, y, size) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(zoomLevel, zoomLevel);
            
            const color = currentMicroorganism.color;
            
            // Draw microorganism type-specific 2D model
            switch(currentMicroorganism.name.toLowerCase()) {
                case 'bacteria':
                    draw2DBacteria(ctx, size, color);
                    break;
                case 'virus':
                    draw2DVirus(ctx, size, color);
                    break;
                case 'fungi':
                    draw2DFungi(ctx, size, color);
                    break;
                case 'protozoa':
                    draw2DProtozoa(ctx, size, color);
                    break;
                case 'algae':
                    draw2DAlgae(ctx, size, color);
                    break;
            }
            
            ctx.restore();
        }

        // 3D Model Drawings
        function draw3DBacteria(ctx, size, color) {
            // Rod-shaped bacteria with 3D shading
            const gradient = ctx.createLinearGradient(-size, -size/2, size, size/2);
            gradient.addColorStop(0, color);
            gradient.addColorStop(0.5, lightenColor(color, 20));
            gradient.addColorStop(1, darkenColor(color, 20));
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.ellipse(0, 0, size * 2, size, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw flagella
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            for (let i = 0; i < 4; i++) {
                const angle = (i * Math.PI) / 2;
                ctx.beginPath();
                ctx.moveTo(-size * 2, 0);
                ctx.quadraticCurveTo(
                    -size * 3, size * Math.sin(angle),
                    -size * 4, size * 1.5 * Math.sin(angle)
                );
                ctx.stroke();
            }
            
            // Draw internal structures
            if (innerViewActive) {
                drawInnerBacteria(ctx, size);
            }
        }

        function draw3DVirus(ctx, size, color) {
            // Icosahedral virus
            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
            gradient.addColorStop(0, lightenColor(color, 30));
            gradient.addColorStop(0.7, color);
            gradient.addColorStop(1, darkenColor(color, 30));
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            for (let i = 0; i < 20; i++) {
                const angle = (i * Math.PI * 2) / 20;
                const x = size * Math.cos(angle);
                const y = size * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            
            // Draw spike proteins
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            for (let i = 0; i < 12; i++) {
                const angle = (i * Math.PI * 2) / 12;
                const x1 = size * Math.cos(angle);
                const y1 = size * Math.sin(angle);
                const x2 = size * 1.3 * Math.cos(angle);
                const y2 = size * 1.3 * Math.sin(angle);
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
        }

        function draw3DFungi(ctx, size, color) {
            // Fungal hyphae network
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            
            // Main hypha
            ctx.beginPath();
            ctx.moveTo(-size, 0);
            ctx.lineTo(size, 0);
            ctx.stroke();
            
            // Branching hyphae
            for (let i = -3; i <= 3; i++) {
                if (i !== 0) {
                    ctx.beginPath();
                    ctx.moveTo(i * size/3, 0);
                    ctx.lineTo(i * size/3 + size/4, -size/2 * Math.sign(i));
                    ctx.stroke();
                }
            }
            
            // Spore at the end
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(size, 0, size/3, 0, Math.PI * 2);
            ctx.fill();
        }

        function draw3DProtozoa(ctx, size, color) {
            // Amoeba-like shape with pseudopodia
            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
            gradient.addColorStop(0, lightenColor(color, 20));
            gradient.addColorStop(1, darkenColor(color, 20));
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            
            // Create organic amoeba shape
            const points = 12;
            for (let i = 0; i <= points; i++) {
                const angle = (i * Math.PI * 2) / points;
                const r = size * (1 + 0.3 * Math.sin(angle * 3 + Date.now() * 0.001));
                const x = r * Math.cos(angle);
                const y = r * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            
            // Pseudopodia
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            for (let i = 0; i < 3; i++) {
                const angle = (i * Math.PI * 2) / 3 + Date.now() * 0.0005;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.quadraticCurveTo(
                    size * Math.cos(angle + 0.5), size * Math.sin(angle + 0.5),
                    size * 1.5 * Math.cos(angle), size * 1.5 * Math.sin(angle)
                );
                ctx.stroke();
            }
        }

        function draw3DAlgae(ctx, size, color) {
            // Algae cell with chloroplasts
            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
            gradient.addColorStop(0, lightenColor(color, 30));
            gradient.addColorStop(0.8, color);
            gradient.addColorStop(1, darkenColor(color, 20));
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.ellipse(0, 0, size, size * 0.7, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Chloroplasts
            ctx.fillStyle = darkenColor(color, 10);
            for (let i = 0; i < 4; i++) {
                const angle = (i * Math.PI) / 2;
                const x = size * 0.5 * Math.cos(angle);
                const y = size * 0.5 * Math.sin(angle);
                ctx.beginPath();
                ctx.ellipse(x, y, size * 0.25, size * 0.15, angle, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Flagella
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-size, 0);
            ctx.quadraticCurveTo(-size * 1.5, -size/4, -size * 2, 0);
            ctx.stroke();
        }

        // 2D Model Drawings
        function draw2DBacteria(ctx, size, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.ellipse(0, 0, size * 1.5, size * 0.6, 0, 0, Math.PI * 2);
            ctx.stroke();
            
            // Internal structures
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(-size * 0.5, 0, size * 0.2, 0, Math.PI * 2);
            ctx.fill();
        }

        function draw2DVirus(ctx, size, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(0, 0, size, 0, Math.PI * 2);
            ctx.stroke();
            
            // Internal genome
            ctx.fillStyle = lightenColor(color, 20);
            ctx.beginPath();
            ctx.arc(0, 0, size * 0.5, 0, Math.PI * 2);
            ctx.fill();
        }

        function draw2DFungi(ctx, size, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(0, 0, size, 0, Math.PI * 2);
            ctx.stroke();
            
            // Simple hyphae
            ctx.beginPath();
            ctx.moveTo(0, size);
            ctx.lineTo(0, size * 2);
            ctx.stroke();
        }

        function draw2DProtozoa(ctx, size, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(0, 0, size, 0, Math.PI * 2);
            ctx.stroke();
            
            // Nucleus
            ctx.fillStyle = lightenColor(color, 20);
            ctx.beginPath();
            ctx.arc(0, 0, size * 0.3, 0, Math.PI * 2);
            ctx.fill();
        }

        function draw2DAlgae(ctx, size, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(0, 0, size, size * 0.7, 0, 0, Math.PI * 2);
            ctx.stroke();
            
            // Chloroplast
            ctx.fillStyle = darkenColor(color, 20);
            ctx.beginPath();
            ctx.ellipse(0, 0, size * 0.5, size * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        // Helper functions
        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function darkenColor(color, percent) {
            return lightenColor(color, -percent);
        }

        function drawLabels(ctx) {
            if (!currentMicroorganism) return;
            
            ctx.save();
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            currentMicroorganism.structures.forEach(structure => {
                const x = ctx.canvas.width / 2 + structure.position[0] * 100 * zoomLevel;
                const y = ctx.canvas.height / 2 + structure.position[1] * 100 * zoomLevel;
                
                ctx.fillText(structure.name, x, y - 10);
            });
            
            ctx.restore();
        }

        // Control functions
        function toggleRotation() {
            isRotating = !isRotating;
        }

        function toggleLabels() {
            showLabels = !showLabels;
        }

        function toggle2D3D() {
            is3D = !is3D;
        }

        function resetView() {
            zoomLevel = 1;
            rotationAngle = 0;
            isRotating = true;
        }

        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 5);
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.5);
        }

        function enterInnerView() {
            innerViewActive = !innerViewActive;
            const btn = document.querySelector('.inner-explorer');
            btn.textContent = innerViewActive ? '🔙 Exit Inner View' : '🔬 Enter Inner View';
        }

        function highlightStructure(index) {
            // Remove active class from all structure items
            document.querySelectorAll('.structure-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected structure
            document.querySelectorAll('.structure-item')[index].classList.add('active');
            
            // Update structure details
            const structure = currentMicroorganism.structures[index];
            document.getElementById('structureDetails').innerHTML = `
                <h4>${structure.name}</h4>
                <p>${structure.description}</p>
            `;
        }

        // Tab functionality
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
            });
        });

        function quickView(key) {
            // Simple alert for quick view - can be expanded
            const micro = microorganisms[key];
            alert(`${micro.name}\n\n${micro.overview}\n\nStructures: ${micro.structures.length}\nFunctions: ${micro.functions.length}`);
        }

        // Responsive canvas resize
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('mainCanvas');
            if (canvas && currentMicroorganism) {
                const container = canvas.parentElement;
                canvas.width = container.offsetWidth;
                canvas.height = 500;
            }
        });
    </script>
</body>
</html>
